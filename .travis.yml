services:
  - postgresql

env:
  global:
    CC_TEST_REPORTER_ID=e187186042e95968f0b6d9c501f42c477d1025666bd6aef6d296c05df95eed4c

jobs:
  include:
    - language: ruby
      rvm:
        - 2.5.7
      before_install:
        - cd api
        - gem install bundler:2.1.4
      install:
        - bundle install
      before_script:
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - rake db:create
        - rake db:migrate
      script:
        - bundle exec rails test
      after_script:
        - cd ..
        - mv api/cc-test-reporter .
        - ./cc-test-reporter format-coverage -t simplecov -o coverage/codeclimate.json ./api/coverage/.resultset.json # Format coverage
        - if [[ "$TRAVIS_TEST_RESULT" == 0 ]]; then ./cc-test-reporter upload-coverage; fi  # Upload coverage/codeclimate.json

    - language: node_js
      node_js: 14
      before_install:
        - cd client
      install:
        - yarn install
      script:
        - yarn run test:unit
